<div class="p-6 max-w-4xl mx-auto">
  <div class="mb-6">
    <h1 class="text-3xl font-bold mb-2">Update Session</h1>
  </div>

  @if (isLoading()) {
    <div class="flex justify-center items-center h-64">
      <i class="pi pi-spin pi-spinner text-4xl text-blue-500"></i>
      <span class="ml-3 text-lg">Loading session data...</span>
    </div>
  } @else {
    <p-card>
      <ng-template #content>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

          <!-- Session Name -->
          <div class="col-span-2">
            <label for="name" class="block text-sm font-medium mb-2">Name</label>
            <input pInputText id="name" [(ngModel)]="name" name="name" class="w-full" placeholder="Enter session name" />
          </div>

          <div class="col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Year -->
            <div>
              <label class="block text-sm font-medium mb-2">Year</label>
              <p-select [options]="[2022, 2023, 2024, 2025, 2026,2027, 2028, 2029, 2030, 2031,2032, 2033, 2034, 2035, 2036]" [(ngModel)]="year" name="year" placeholder="Select year" class="w-full" />
            </div>
            
            <!-- Month -->
            <div>
              <label class="block text-sm font-medium mb-2">Month</label>
              <p-select [options]="[01, 02,03, 04, 05, 06, 07, 08, 09, 10, 11,12]" [(ngModel)]="month" name="month" placeholder="Select month" class="w-full" />
            </div>
            
            <!-- Session Type -->
            <div>
              <label for="type" class="block text-sm font-medium mb-2">Session Type</label>
              <p-select [(ngModel)]="type" name="type" inputId="type"
                [options]="[{ label: '線上', value: '線上' },{ label: '招牌', value: '招牌' },{ label: '寶寶', value: '寶寶' },{ label: '其他', value: '其他' }]" optionLabel="label" optionValue="value" placeholder="Select session type" class="w-full" />
            </div>
          </div>

          <!-- Image Upload -->
          <div class="col-span-2">
            <label for="fileUpload" class="block text-sm font-medium mb-3">Session Image</label>
            <!-- Image Display Area - Priority Display -->
            @if (uploadedImageUrl()) {
              <div class="mb-4">
                <div class="relative inline-block">
                  <img [src]="uploadedImageUrl()" alt="Session preview"
                    class="w-full max-w-md h-auto object-contain rounded-lg border border-gray-200 shadow-sm sm:max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl"
                    loading="lazy" />
                  <div
                    class="absolute top-2 right-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full flex items-center">
                    <i class="pi pi-check mr-1"></i>
                    Current Image
                  </div>
                </div>
              </div>
            }
            <!-- File Upload Button Area -->
            <div class="space-y-3">
              <p-fileupload #fileUpload mode="basic" name="sendimage" [auto]="false" accept="image/*"
                [maxFileSize]="10000000" (onSelect)="onFileSelect($event)" chooseLabel="Choose New Image"
                ariaLabel="Upload session image" [disabled]="isUploading()" class="w-full" />

              <!-- Upload Status Display -->
              @if (isUploading()) {
              <div class="flex items-center text-sm text-blue-600 bg-blue-50 p-3 rounded-lg">
                <i class="pi pi-spin pi-spinner mr-2"></i>
                <span>Uploading image...</span>
              </div>
              }

              <!-- File Selection Status -->
              @if (selectedFile() && !isUploading() && !uploadedImageUrl()) {
              <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">
                <i class="pi pi-file mr-2"></i>
                Selected: {{ selectedFile()!.name }}
              </div>
              }
            </div>
          </div>

          <!-- Description -->
          <div class="col-span-2">
            <label for="text" class="block text-sm font-medium mb-2">Description</label>
            <textarea pInputTextarea [(ngModel)]="description" name="description" id="text" rows="5" class="w-full"
              placeholder="Enter session description"></textarea>
          </div>

          <!-- Min Participants -->
          <div>
            <label for="min" class="block text-sm font-medium mb-2">Min Participants</label>
            <p-inputnumber [(ngModel)]="min" name="min" inputId="min" [min]="0" class="w-full" />
          </div>

          <!-- Max Participants -->
          <div>
            <label for="max" class="block text-sm font-medium mb-2">Max Participants</label>
            <p-inputnumber [(ngModel)]="max" name="max" inputId="max" [min]="0" class="w-full"/>
          </div>

          <!-- Max Standby -->
          <div>
            <label for="maxStandby" class="block text-sm font-medium mb-2">Max Standby</label>
            <p-inputnumber [(ngModel)]="maxStandby" name="maxStandby" inputId="maxStandby" [min]="0" class="w-full" />
          </div>

          <!-- Publish Status -->
          <div class="col-span-2">
            <fieldset>
              <legend class="block text-sm font-medium mb-2">Publish Status</legend>
              <p-selectbutton [(ngModel)]="publish" name="publish" [options]="[{ label: 'Published', value: 1 },{ label: 'Hidden', value: 0 }]" optionLabel="label" optionValue="value" ariaLabel="Choose publish status" />
            </fieldset>
          </div>

          <!-- Time Slots Section -->
          <div class="col-span-2">
            <div class="flex justify-between items-center mb-3">
              <label class="block text-sm font-medium">Event Time Slots</label>
              <p-button label="Add Time Slot" icon="pi pi-plus" severity="info" [outlined]="true" size="small" 
                 type="button" (click)="addTime()"/>
            </div>
            
            <div class="space-y-4">
              @for (slot of timeList(); track $index) {
                <div class="grid gap-3" style="grid-template-columns: auto auto 1fr auto;">
                  <input type="date" [(ngModel)]="slot.date" name="date-{{$index}}" class="w-full p-2 border border-gray-300 rounded-md" />
                  <input type="text" pInputText [(ngModel)]="slot.time" name="time-{{$index}}" placeholder="HH:mm" pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$" maxlength="5" title="如14:45" style="min-width: 83px; width:83px"/>
                
                  <input type="text" pInputText [(ngModel)]="slot.text" name="text-{{$index}}" placeholder="Time slot description" />
                  <p-button icon="pi pi-times" severity="danger" [outlined]="true" size="small" type="button" pTooltip="Remove this time slot" tooltipPosition="top" (click)="deleteThisTime($index)" />
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end gap-3 mt-6" role="group" aria-label="Form actions">
          <p-button label="Cancel" severity="secondary" [outlined]="true" type="button" (onClick)="onCancel()"
            ariaLabel="Cancel and return to list" />
          <p-button label="Update Session" type="submit" [loading]="isSubmitting()"
            ariaLabel="Update session with provided details" (click)="onSubmit()" />
        </div>
      </ng-template>
    </p-card>
  }
</div>